AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Parameters:
  ecrRepositoryName:
    Type: String
    Description: The name of the ECR repository
  taskName:
    Type: String
    Description: The name of the ECS task definition
  defaultRepositoryName:
    Type: String
    Description: The default ECR image name
  vpcCidr:
    Type: String
    Description: The CIDR block for the VPC
  subnet1Cidrs:
    Type: String
    Description: A comma-separated list of CIDR blocks for subnet 1
  gitConnectionId:
    Type: String
    Description: The Git connection ID
  notificationEmail:
    Type: String
    Description: The email address to send notifications to
Resources:
  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: NetworkStack/template.yaml
      Parameters:
        vpcCidr:
          Ref: vpcCidr
        subnet1Cidrs:
          Ref: subnet1Cidrs
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Metadata:
      SamResourceId: NetworkStack
  LoadBalancerStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: LoadBalancerStack/template.yaml
      Parameters:
        vpc:
          Fn::GetAtt:
          - NetworkStack
          - Outputs.vpc
        subnets:
          Fn::GetAtt:
          - NetworkStack
          - Outputs.subnets
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Metadata:
      SamResourceId: LoadBalancerStack
  ECSClusterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ECSClusterStack/template.yaml
      Parameters:
        vpc:
          Fn::GetAtt:
          - NetworkStack
          - Outputs.vpc
        ecsSubnets:
          Fn::GetAtt:
          - NetworkStack
          - Outputs.subnets
        loadBalancerSecurityGroup:
          Fn::GetAtt:
          - LoadBalancerStack
          - Outputs.SecurityGoup
        prodTargetGroupArn:
          Fn::GetAtt:
          - LoadBalancerStack
          - Outputs.ProdTargetGroupArn
        defaultRepositoryName:
          Ref: defaultRepositoryName
        ecrRepositoryName:
          Ref: ecrRepositoryName
        taskName:
          Ref: taskName
        notificationEmail:
          Ref: notificationEmail
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Metadata:
      SamResourceId: ECSClusterStack
  CodeBuildStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: CodeBuildStack/template.yaml
      Parameters:
        artifactsBucketName:
          Fn::Sub: ${AWS::StackName}-artifacts-bucket-${AWS::Region}-${AWS::AccountId}
        ecrRepositoryName:
          Ref: ecrRepositoryName
        ecsTaskName:
          Ref: taskName
        ecsTaskExecutionRoleName:
          Fn::GetAtt:
          - ECSClusterStack
          - Outputs.ecsTaskExecutionRoleName
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Metadata:
      SamResourceId: CodeBuildStack
  ArtifactsBucketStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ArtifactsBucketStack/template.yaml
      Parameters:
        artifactsBucketName:
          Fn::Sub: ${AWS::StackName}-artifacts-bucket-${AWS::Region}-${AWS::AccountId}
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Metadata:
      SamResourceId: ArtifactsBucketStack
  CodeDeployStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: CodeDeployStack/template.yaml
      Parameters:
        ECSClusterName:
          Fn::GetAtt:
          - ECSClusterStack
          - Outputs.ECSClusterName
        ECSServiceName:
          Fn::GetAtt:
          - ECSClusterStack
          - Outputs.ECSServiceName
        ProdTargetGroupName:
          Fn::GetAtt:
          - LoadBalancerStack
          - Outputs.ProdTargetGroupName
        TestTargetGroupName:
          Fn::GetAtt:
          - LoadBalancerStack
          - Outputs.TestTargetGroupName
        ProdListenerArn:
          Fn::GetAtt:
          - LoadBalancerStack
          - Outputs.ProdListenerArn
        TestListenerArn:
          Fn::GetAtt:
          - LoadBalancerStack
          - Outputs.TestListenerArn
        notificationEmail:
          Ref: notificationEmail
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Metadata:
      SamResourceId: CodeDeployStack
  CodePipelineStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: CodePipelineStack/template.yaml
      Parameters:
        codeBuildProject:
          Fn::GetAtt:
          - CodeBuildStack
          - Outputs.CodeBuildProjectName
        artifactsBucketName:
          Fn::GetAtt:
          - ArtifactsBucketStack
          - Outputs.ArtifactsBucketName
        codeDeoloyApplicationName:
          Fn::GetAtt:
          - CodeDeployStack
          - Outputs.CodeDeployApplicationName
        codeDeployDeploymentGroupName:
          Fn::GetAtt:
          - CodeDeployStack
          - Outputs.CodeDeployDeploymentGroupName
        gitConnectionId:
          Ref: gitConnectionId
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Metadata:
      SamResourceId: CodePipelineStack
Outputs:
  LoadBalancerDNSName:
    Value:
      Fn::GetAtt:
      - LoadBalancerStack
      - Outputs.LoadBalancerDNSName
    Description: The DNS name of the load balancer
