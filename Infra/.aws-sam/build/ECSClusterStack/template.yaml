AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Parameters:
  vpc:
    Type: String
    Description: The VPC ID
  ecsSubnets:
    Type: String
    Description: A list of subnet IDs for the ECS service
  loadBalancerSecurityGroup:
    Type: String
    Description: The security group ID for the load balancer
  prodTargetGroupArn:
    Type: String
    Description: The ARN of the production target group
  defaultRepositoryName:
    Type: String
    Description: The default ECR image name
  ecrRepositoryName:
    Type: String
    Description: The ECR repository name
  taskName:
    Type: String
    Description: The name of the ECS task definition
  notificationEmail:
    Type: String
    Description: Email address for CloudWatch alarms
Resources:
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: my-ecs-cluster
      CapacityProviders:
      - FARGATE
  ECSServiceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ECS service
      VpcId:
        Ref: vpc
  ECSServiceSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId:
        Ref: ECSServiceSecurityGroup
      IpProtocol: tcp
      FromPort: 3000
      ToPort: 3000
      SourceSecurityGroupId:
        Ref: loadBalancerSecurityGroup
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
  ECSTaskLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /ecs/${taskName}
      RetentionInDays: 1
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
  LogFilterMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '%\[ERROR\] 500%'
      LogGroupName:
        Ref: ECSTaskLogGroup
      MetricTransformations:
      - MetricName:
          Fn::Sub: ${taskName}500Count
        MetricNamespace: Logs
        MetricValue: 1
  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName:
        Fn::Sub: ${taskName}-alarm-topic
      Subscription:
      - Protocol: email
        Endpoint:
          Ref: notificationEmail
  LogFilterMetricAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        Fn::Sub: ${taskName}500Count
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      MetricName: myApi500Count
      Namespace: My-api
      Period: 60
      Statistic: Sum
      Threshold: 5
      ActionsEnabled: true
      AlarmActions:
      - Fn::GetAtt:
        - AlarmTopic
        - TopicArn
      AlarmDescription: Alarm when 500 errors exceed threshold
      TreatMissingData: notBreaching
  ECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family:
        Ref: taskName
      Cpu: 256
      Memory: 512
      NetworkMode: awsvpc
      ExecutionRoleArn:
        Ref: ECSTaskExecutionRole
      RequiresCompatibilities:
      - FARGATE
      ContainerDefinitions:
      - Name:
          Ref: ecrRepositoryName
        Image:
          Fn::Sub: ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${defaultRepositoryName}:latest
        PortMappings:
        - ContainerPort: 3000
          Protocol: tcp
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: ECSTaskLogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: ecs
  ECSService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Ref: ECSCluster
      ServiceName: my-ecs-service
      TaskDefinition:
        Ref: ECSTaskDefinition
      DesiredCount: 1
      LaunchType: FARGATE
      DeploymentController:
        Type: CODE_DEPLOY
      LoadBalancers:
      - TargetGroupArn:
          Ref: prodTargetGroupArn
        ContainerName: my-api
        ContainerPort: 3000
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          Subnets:
            Fn::Split:
            - ','
            - Ref: ecsSubnets
          SecurityGroups:
          - Ref: ECSServiceSecurityGroup
Outputs:
  ECSClusterName:
    Description: The name of the ECS cluster
    Value:
      Ref: ECSCluster
  ECSServiceName:
    Description: The name of the ECS service
    Value:
      Fn::GetAtt:
      - ECSService
      - Name
  ecsTaskExecutionRoleName:
    Description: The ECS task execution role
    Value:
      Ref: ECSTaskExecutionRole
